(()=>{"use strict";(()=>{function e(e,t){let s=document.querySelector("#viewing").content.firstElementChild.cloneNode(!0),i=s.querySelector("iframe");return i.style.height="100vh",i.style.width="100vw",i.src=`https://www.figma.com/embed?embed_host=kosy&url=${e.figmaUrl}`,s}function t(e){return e&&e.match("https://([w.-]+.)?figma.com/(file|proto)/([0-9a-zA-Z]{22,128})(?:/.*)?$")}function s(e,s){let i=document.querySelector("#picking").content.cloneNode(!0),n=i.querySelector("input"),a=i.querySelector("#open-file");document.querySelector("#viewing").hidden=!0;let o=i.querySelector("#error");return n.oninput=e=>{const s=n.value;n.classList.remove("invalid"),n.classList.remove("valid"),a.classList.remove("valid"),t(s)?(a.removeAttribute("disabled"),o.innerHTML="",o.style.marginBottom="0",o.style.marginTop="0",n.style.color="black",a.classList.add("valid"),n.classList.add("valid")):(o.innerHTML="This is an invalid figma url",o.style.marginBottom="16px",o.style.marginTop="5px",a.setAttribute("disabled","disabled"),n.classList.add("invalid"),n.style.color="red")},a.onclick=e=>{let t=n.value;s({type:"figma-url-changed",payload:t})},i}function i(e,t){let s=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0);return s.querySelector("label").innerHTML=`${e.initializer.clientName} is picking a file to share`,s}class n{constructor(e){this.kosyClient=window.parent,this.latestMessageNumber=0,this.kosyApp=e}dictionaryToArray(e){let t=[];for(const s in e)e.hasOwnProperty(s)&&t.push([s,e[s]]);return t}startApp(){return this.initialInfoPromise=new Promise(((e,t)=>{window.addEventListener("message",(t=>{let s=t.data;switch(s.type){case"receive-initial-info":this.latestMessageNumber=s.latestMessageNumber,this.clients=s.payload.clients,this.hostClientUuid=s.payload.initializerClientUuid,this.log("Resolving initial info promise with: ",s.payload),e(s.payload);break;case"set-client-info":{let e=s.clients,t=s.hostClientUuid;this.initialInfoPromise.then((i=>{let n=this.dictionaryToArray(e).filter((e=>!this.clients[e[0]])),a=this.dictionaryToArray(this.clients).filter((t=>!e[t[0]])),o=this.latestMessageNumber;t!==this.hostClientUuid&&"function"==typeof this.kosyApp.onHostHasChanged&&(this.log("On host has changed was defined -> notifying everyone the host has changed",s),this._relayMessageToClients(i,{type:"_host-has-changed",clientUuid:t},++o)),n.length>0&&"function"==typeof this.kosyApp.onClientHasJoined&&(this.log("On client has joined was defined",s),n.forEach((e=>this._relayMessageToClients(i,{type:"_client-has-joined",clientInfo:e[1]},++o)))),a.length>0&&"function"==typeof this.kosyApp.onClientHasLeft&&(this.log("On client has left was defined",s),a.forEach((e=>this._relayMessageToClients(i,{type:"_client-has-left",clientUuid:e[0]},++o)))),this.clients=e,this.hostClientUuid=t}));break}case"get-app-state":{let e=s.clientUuids;this.log("Get app state received -> sending app state");const t=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",state:t,clientUuids:e,latestMessageNumber:this.latestMessageNumber});break}case"set-app-state":this.latestMessageNumber=s.latestMessageNumber;let t=s.state;this.initialInfoPromise.then((()=>{this.log("Received app state from Kosy -> setting app state"),this.kosyApp.onProvideState(t)}));break;case"receive-message-as-host":this._handleReceiveMessageAsHost(s);break;case"receive-message-as-client":this._handleReceiveMessageAsClient(s)}})),this._sendMessageToKosy({type:"ready-and-listening"})})),this.initialInfoPromise}stopApp(){this._sendMessageToKosy({type:"stop-app"})}relayMessage(e){this.log("Relaying client message to host: ",e),this._sendMessageToKosy({type:"relay-message-to-host",message:e})}_relayMessageToClients(e,t,s){this.log("Relaying host to client message: ",t),this._sendMessageToKosy({type:"relay-message-to-clients",sentByClientUuid:e.currentClientUuid,message:t,messageNumber:s})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}_handleReceiveMessageAsClientRecursive(e,t,s){var i,n,a,o,l,r;if(this.latestMessageNumber===e.messageNumber-1){switch(e.message.type){case"_host-has-changed":null===(n=(i=this.kosyApp).onHostHasChanged)||void 0===n||n.call(i,e.message.clientUuid);break;case"_client-has-joined":null===(o=(a=this.kosyApp).onClientHasJoined)||void 0===o||o.call(a,e.message.clientInfo);break;case"_client-has-left":null===(r=(l=this.kosyApp).onClientHasLeft)||void 0===r||r.call(l,e.message.clientUuid);break;default:this.kosyApp.onReceiveMessageAsClient(e.message)}this.latestMessageNumber=e.messageNumber}else s<50&&this.latestMessageNumber<e.messageNumber?setTimeout((()=>this._handleReceiveMessageAsClientRecursive(e,t,s+1)),100):(this.log("Timeout on processing message as client: ",e.message),this.log("Wait for Kosy to fix this mess..."))}_handleReceiveMessageAsClient(e){this.initialInfoPromise.then((t=>{this.log("Received message as client, processing: ",e.message),this._handleReceiveMessageAsClientRecursive(e,t,0)}))}_handleReceiveMessageAsHost(e){this.initialInfoPromise.then((t=>{this.log("Trying to handle message as host");const s=this.kosyApp.onReceiveMessageAsHost(e.message);s&&this._relayMessageToClients(t,s,this.latestMessageNumber+1)}))}log(...e){"1"===localStorage.getItem("debug-mode")&&console.log("From kosy-app-api: ",...e)}}var a;!function(a){var o;(function(a){class o{constructor(){this.state={figmaUrl:null},this.kosyApi=new n({onClientHasLeft:e=>this.onClientHasLeft(e),onReceiveMessageAsClient:e=>this.processMessageAsClient(e),onReceiveMessageAsHost:e=>e,onRequestState:()=>this.getState(),onProvideState:e=>this.setState(e)})}start(){var e,t,s,i,n;return t=this,s=void 0,n=function*(){let t=yield this.kosyApi.startApp();this.initializer=t.clients[t.initializerClientUuid],this.currentClient=t.clients[t.currentClientUuid],this.state=null!==(e=t.currentAppState)&&void 0!==e?e:this.state,this.renderComponent(),window.addEventListener("message",(e=>{this.processComponentMessage(e.data)}))},new((i=void 0)||(i=Promise))((function(e,a){function o(e){try{r(n.next(e))}catch(e){a(e)}}function l(e){try{r(n.throw(e))}catch(e){a(e)}}function r(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i((function(e){e(s)}))).then(o,l)}r((n=n.apply(t,s||[])).next())}))}setState(e){this.state=e,this.renderComponent()}getState(){return this.state}onClientHasLeft(e){e!==this.initializer.clientUuid||this.state.figmaUrl||this.kosyApi.stopApp()}processMessageAsClient(e){"receive-figma-url"===e.type&&t(e.payload)&&(this.state.figmaUrl=`${e.payload}`,this.renderComponent())}processComponentMessage(e){"figma-url-changed"===e.type&&this.kosyApi.relayMessage({type:"receive-figma-url",payload:e.payload})}renderComponent(){!function(t,n){let a,o=document.getElementById("root");a=(null==t?void 0:t.figmaUrl)?e:t.currentClient.clientUuid==t.initializer.clientUuid?s:i;var l=o.cloneNode(!1);o.parentNode.replaceChild(l,o),l.appendChild(a(t,n))}({figmaUrl:this.state.figmaUrl,currentClient:this.currentClient,initializer:this.initializer},(e=>this.processComponentMessage(e)))}log(...e){var t,s;console.log(`${null!==(s=null===(t=this.currentClient)||void 0===t?void 0:t.clientName)&&void 0!==s?s:"New user"} logged: `,...e)}}a.App=o,(new o).start()})((o=a.Integration||(a.Integration={})).Figma||(o.Figma={}))}(a||(a={}))})()})();